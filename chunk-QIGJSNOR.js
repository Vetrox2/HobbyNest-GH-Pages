import{a as R}from"./chunk-RKJUSBNY.js";import{a as T,f as A}from"./chunk-FQGZ55FF.js";import{a as D}from"./chunk-NQHDFXLN.js";import{a as E}from"./chunk-UFHDFMSB.js";import{m as y}from"./chunk-7XV4WYW5.js";import{x as S}from"./chunk-UKFAUT6A.js";import{B as s,Db as g,Y as l,Yc as C,aa as v,ga as d,j as u,l as h,p as I,z as b}from"./chunk-BNW6Q7MZ.js";import{a as n,b as a}from"./chunk-EQDQRRRY.js";var f=class p{router=d(A);lastVisitedUrl=null;isNavigatingToLogin=g(!1);navigationStart$=this.router.events.pipe(b(e=>e instanceof T));setLastVisitedUrl(e){this.lastVisitedUrl=e}navigateToLastVisited(){this.router.navigateByUrl(this.lastVisitedUrl??"/")}navigateWithoutHistory(e){this.router.navigate([e],{replaceUrl:!0})}navigateTo(e){this.router.navigate([e])}navigateWithParams(e,t){this.router.navigate([e,t])}navigateToHome(){this.router.navigate(this.pathToHome)}navigateToProfile(){this.router.navigate(this.pathToProfile)}navigateToSearch(){this.router.navigate(this.pathToSearch)}navigateToSettings(){this.router.navigate(this.pathToSettings)}navigateToAbout(){this.router.navigate(this.pathToAbout)}navigateToLegal(){this.router.navigate(this.pathToLegal)}navigateToLogin(){this.isNavigatingToLogin.set(!0),this.router.navigate(this.pathToLogin)}navigateToAgeDisclaimer(){this.router.navigate(this.pathToAgeDisclaimer)}navigateToAdmin(){this.router.navigate(this.pathToAdmin)}navigateIfAuthenticated(e,t){this.router.navigate(t?[e]:this.pathToLogin)}get pathToHome(){return["/home"]}get pathToProfile(){return["/profile"]}get pathToSearch(){return["/search"]}get pathToCollections(){return["/collections"]}get pathToSettings(){return["/settings"]}get pathToAbout(){return["/about"]}get pathToLegal(){return["/legal"]}get pathToLogin(){return["/login"]}get pathToAgeDisclaimer(){return["/age-disclaimer"]}get pathToAdmin(){return["/admin"]}static \u0275fac=function(t){return new(t||p)};static \u0275prov=v({token:p,factory:p.\u0275fac,providedIn:"root"})};var w=(r=>(r.Media="media",r.Series="series",r.Season="season",r.Episode="episode",r.Custom="custom",r))(w||{});var U=class p{userService=d(R);collectionService=d(E);collectionItemService=d(D);notificationService=d(y);navigationService=d(f);statusChangedSuccessMessage=S("notification.statusChangedSuccess");itemAlreadyInCollectionMessage=S("notification.itemAlreadyInCollection");currentCollection=g(null);currentCollectionItems=g(null);currentCollectionOwner=g(null);currentRatedItems=C(()=>this.currentCollectionItems()?.filter(e=>!e.toDo));currentToDoItems=C(()=>this.currentCollectionItems()?.filter(e=>e.toDo));isCollectionOwner=C(()=>this.currentCollection()?.userId===this.userService.selfUser()?.id);setCurrentCollectionData(e,t,i){this.currentCollection.set(e),this.currentCollectionItems.set(t),this.currentCollectionOwner.set(i)}resetState(){this.currentCollection.set(null),this.currentCollectionItems.set(null),this.currentCollectionOwner.set(null)}renameCollection(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionName(t.id,e,t.name).pipe(l(()=>{this.currentCollection.update(i=>i?a(n({},i),{name:e}):null)}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}changeCollectionPublicStatus(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionPublicStatus(t.id,e).pipe(l(()=>{this.currentCollection.update(i=>i?a(n({},i),{isPublic:e}):null)}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollection(){let e=this.currentCollection();e&&this.collectionService.deleteCollection(e.id).pipe(l(()=>{this.resetState(),this.navigationService.navigateTo("/collections")}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}addCustomItem(e){return this.addItem(e,t=>this.collectionItemService.addCustomItem(t))}addMediaItem(e){return this.addItem(e,t=>this.collectionItemService.addMediaItem(t))}updateItemDoToStatus(e,t){let i=this.currentCollectionItems()?.findIndex(c=>c.id===e);if(i===void 0||i===-1)return;var o=this.currentCollectionItems()?.at(i)?.toDo;if(t===o)return;t===void 0&&(t=!o);let r={id:e,toDo:t};this.collectionItemService.updateItemToDoStatus(r).pipe(l(()=>{this.currentCollectionItems.update(c=>{if(!c)return c;let m=[...c];return m[i]=a(n({},m[i]),{toDo:t}),this.notificationService.showSuccess(this.statusChangedSuccessMessage()),m})}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollectionItem(e){this.collectionItemService.deleteItem(e).pipe(l(()=>{this.currentCollectionItems.update(t=>{if(!t)return t;let i=t.findIndex(r=>r.id===e);if(i===-1)return t;let o=[...t];return o.splice(i,1),this.notificationService.showSuccess(),o})}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}updateItemRating(e){return this.collectionItemService.updateItemRating(e).pipe(l(()=>{this.currentCollectionItems.update(t=>t?t.map(i=>i.id===e.id?a(n({},i),{rating:e.rating}):i):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),h(!1))))}updateSeriesSubItemRating(e){if(!this.isValidModel(e))return this.notificationService.showFailure(),h(!1);let t=this.isEpisodeChange(e);return this.sendSubItemRatingUpdate(e,t).pipe(l(i=>{this.currentCollectionItems.update(o=>o?o.map(r=>this.updateSeriesItem(r,e,i,t)):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),h(!1))))}updateCustomItemTitle(e,t){this.collectionItemService.updateCustomItemTitle(e,t).pipe(l(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?a(n({},o),{item:a(n({},o.item),{title:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}updateCustomItemDescription(e,t){this.collectionItemService.updateCustomItemDescription(e,t).pipe(l(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?a(n({},o),{item:a(n({},o.item),{description:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}addItem(e,t){return t(e).pipe(l(i=>{this.currentCollectionItems.update(o=>o?[...o,i]:[i])}),I(()=>({result:!0,alreadyExists:!1})),s(i=>{let o=i instanceof Error?i.message:typeof i=="string"?i:void 0;return o==="The item is already part of the selected collection."?(this.notificationService.showFailure(this.itemAlreadyInCollectionMessage()),h({result:!1,alreadyExists:!0})):(this.notificationService.showFailure(o),h({result:!1,alreadyExists:!1}))}))}isValidModel(e){return!!(e.seriesCollectionItemId&&(e.seasonApiId||e.seasonCollectionItemId))}isEpisodeChange(e){return!!(e.episodeCollectionItemId||e.episodeApiId)}updateSeriesItem(e,t,i,o){if(e.id!==t.seriesCollectionItemId)return e;let r=e,c=r.item.seasons.map(m=>this.updateSeason(m,t,i,o));return a(n({},r),{item:a(n({},r.item),{seasons:c})})}updateSeason(e,t,i,o){let r=!!t.seasonCollectionItemId&&t.seasonCollectionItemId===e.id,c=!t.seasonCollectionItemId&&e.item.apiId===t.seasonApiId;if(!r&&!c)return e;if(o){let m=e.item.episodes.map(x=>this.updateEpisode(x,t,i));return a(n({},e),{item:a(n({},e.item),{episodes:m})})}else return r?a(n({},e),{rating:t.value}):i?a(n({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}updateEpisode(e,t,i){return t.episodeCollectionItemId?t.episodeCollectionItemId!==e.id?e:a(n({},e),{rating:t.value}):e.item.apiId!==t.episodeApiId?e:i?a(n({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}sendSubItemRatingUpdate(e,t){return t?e.episodeCollectionItemId?this.collectionItemService.updateItemRating({id:e.episodeCollectionItemId,rating:e.value}):this.collectionItemService.addEpisodeCollectionItem({collectionId:this.currentCollection().id,apiId:e.episodeApiId,rating:e.value,toDo:!1}):e.seasonCollectionItemId?this.collectionItemService.updateItemRating({id:e.seasonCollectionItemId,rating:e.value}):this.collectionItemService.addSeasonCollectionItem({collectionId:this.currentCollection().id,apiId:e.seasonApiId,rating:e.value,toDo:!1})}static \u0275fac=function(t){return new(t||p)};static \u0275prov=v({token:p,factory:p.\u0275fac,providedIn:"root"})};export{f as a,w as b,U as c};
