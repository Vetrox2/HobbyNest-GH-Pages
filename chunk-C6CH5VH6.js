import{a as E}from"./chunk-NHA5TDGA.js";import{a as y}from"./chunk-3OHKX2NB.js";import{a as g}from"./chunk-MEWO5AOR.js";import{l as v}from"./chunk-T7LPRNXJ.js";import{a as A}from"./chunk-5GXUJLS4.js";import{x as S}from"./chunk-RAN27MHH.js";import{$c as h,B as s,Db as C,Y as a,aa as b,ga as p,j as u,l as m,p as I}from"./chunk-ZS453FTV.js";import{a as r,b as l}from"./chunk-EQDQRRRY.js";var R=(n=>(n.Media="media",n.Series="series",n.Season="season",n.Episode="episode",n.Custom="custom",n))(R||{});var D=class f{userService=p(y);collectionService=p(g);collectionItemService=p(E);notificationService=p(v);navigationService=p(A);statusChangedSuccessMessage=S("notification.statusChangedSuccess");itemAlreadyInCollectionMessage=S("notification.itemAlreadyInCollection");currentCollection=C(null);currentCollectionItems=C(null);currentCollectionOwner=C(null);currentRatedItems=h(()=>this.currentCollectionItems()?.filter(e=>!e.toDo));currentToDoItems=h(()=>this.currentCollectionItems()?.filter(e=>e.toDo));isCollectionOwner=h(()=>this.currentCollection()?.userId===this.userService.selfUser()?.id);setCurrentCollectionData(e,t,i){this.currentCollection.set(e),this.currentCollectionItems.set(t),this.currentCollectionOwner.set(i)}resetState(){this.currentCollection.set(null),this.currentCollectionItems.set(null),this.currentCollectionOwner.set(null)}renameCollection(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionName(t.id,e,t.name).pipe(a(()=>{this.currentCollection.update(i=>i?l(r({},i),{name:e}):null)}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}changeCollectionPublicStatus(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionPublicStatus(t.id,e).pipe(a(()=>{this.currentCollection.update(i=>i?l(r({},i),{isPublic:e}):null)}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollection(){let e=this.currentCollection();e&&this.collectionService.deleteCollection(e.id).pipe(a(()=>{this.resetState(),this.navigationService.navigateTo("/collections")}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}addCustomItem(e){return this.addItem(e,t=>this.collectionItemService.addCustomItem(t))}addMediaItem(e){return this.addItem(e,t=>this.collectionItemService.addMediaItem(t))}updateItemDoToStatus(e,t){let i=this.currentCollectionItems()?.findIndex(c=>c.id===e);if(i===void 0||i===-1)return;var o=this.currentCollectionItems()?.at(i)?.toDo;if(t===o)return;t===void 0&&(t=!o);let n={id:e,toDo:t};this.collectionItemService.updateItemToDoStatus(n).pipe(a(()=>{this.currentCollectionItems.update(c=>{if(!c)return c;let d=[...c];return d[i]=l(r({},d[i]),{toDo:t}),this.notificationService.showSuccess(this.statusChangedSuccessMessage()),d})}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollectionItem(e){this.collectionItemService.deleteItem(e).pipe(a(()=>{this.currentCollectionItems.update(t=>{if(!t)return t;let i=t.findIndex(n=>n.id===e);if(i===-1)return t;let o=[...t];return o.splice(i,1),this.notificationService.showSuccess(),o})}),s(()=>(this.notificationService.showFailure(),u))).subscribe()}updateItemRating(e){return this.collectionItemService.updateItemRating(e).pipe(a(()=>{this.currentCollectionItems.update(t=>t?t.map(i=>i.id===e.id?l(r({},i),{rating:e.rating}):i):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),m(!1))))}updateSeriesSubItemRating(e){if(!this.isValidModel(e))return this.notificationService.showFailure(),m(!1);let t=this.isEpisodeChange(e);return this.sendSubItemRatingUpdate(e,t).pipe(a(i=>{this.currentCollectionItems.update(o=>o?o.map(n=>this.updateSeriesItem(n,e,i,t)):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),m(!1))))}updateCustomItemTitle(e,t){this.collectionItemService.updateCustomItemTitle(e,t).pipe(a(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?l(r({},o),{item:l(r({},o.item),{title:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}updateCustomItemDescription(e,t){this.collectionItemService.updateCustomItemDescription(e,t).pipe(a(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?l(r({},o),{item:l(r({},o.item),{description:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}addItem(e,t){return t(e).pipe(a(i=>{this.currentCollectionItems.update(o=>o?[...o,i]:[i])}),I(()=>({result:!0,alreadyExists:!1})),s(i=>{let o=i instanceof Error?i.message:typeof i=="string"?i:void 0;return o==="The item is already part of the selected collection."?(this.notificationService.showFailure(this.itemAlreadyInCollectionMessage()),m({result:!1,alreadyExists:!0})):(this.notificationService.showFailure(o),m({result:!1,alreadyExists:!1}))}))}isValidModel(e){return!!(e.seriesCollectionItemId&&(e.seasonApiId||e.seasonCollectionItemId))}isEpisodeChange(e){return!!(e.episodeCollectionItemId||e.episodeApiId)}updateSeriesItem(e,t,i,o){if(e.id!==t.seriesCollectionItemId)return e;let n=e,c=n.item.seasons.map(d=>this.updateSeason(d,t,i,o));return l(r({},n),{item:l(r({},n.item),{seasons:c})})}updateSeason(e,t,i,o){let n=!!t.seasonCollectionItemId&&t.seasonCollectionItemId===e.id,c=!t.seasonCollectionItemId&&e.item.apiId===t.seasonApiId;if(!n&&!c)return e;if(o){let d=e.item.episodes.map(w=>this.updateEpisode(w,t,i));return l(r({},e),{item:l(r({},e.item),{episodes:d})})}else return n?l(r({},e),{rating:t.value}):i?l(r({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}updateEpisode(e,t,i){return t.episodeCollectionItemId?t.episodeCollectionItemId!==e.id?e:l(r({},e),{rating:t.value}):e.item.apiId!==t.episodeApiId?e:i?l(r({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}sendSubItemRatingUpdate(e,t){return t?e.episodeCollectionItemId?this.collectionItemService.updateItemRating({id:e.episodeCollectionItemId,rating:e.value}):this.collectionItemService.addEpisodeCollectionItem({collectionId:this.currentCollection().id,apiId:e.episodeApiId,rating:e.value,toDo:!1}):e.seasonCollectionItemId?this.collectionItemService.updateItemRating({id:e.seasonCollectionItemId,rating:e.value}):this.collectionItemService.addSeasonCollectionItem({collectionId:this.currentCollection().id,apiId:e.seasonApiId,rating:e.value,toDo:!1})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=b({token:f,factory:f.\u0275fac,providedIn:"root"})};export{R as a,D as b};
