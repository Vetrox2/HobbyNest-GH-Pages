import{a as w}from"./chunk-JRISVNOQ.js";import{e as f}from"./chunk-6GCO2BRC.js";import{a as A}from"./chunk-HUJZVVKV.js";import{a as T}from"./chunk-QQTTX4SM.js";import{s as b}from"./chunk-GB5FS4AS.js";import{Db as p,E as s,Xc as v,_ as l,a as r,b as a,ca as g,ia as u,m as c,o as h,s as I}from"./chunk-GTZL7DLP.js";var C=class d{_router=u(f);isNavigatingToLogin=p(!1);_lastVisitedUrl=null;setLastVisitedUrl(e){this._lastVisitedUrl=e}navigateToLastVisited(){this._router.navigateByUrl(this._lastVisitedUrl??"/")}navigateWithoutHistory(e){this._router.navigate([e],{replaceUrl:!0})}navigateTo(e){this._router.navigate([e])}navigateWithParams(e,t){this._router.navigate([e,t])}navigateToHome(){this._router.navigate(this.pathToHome)}navigateToProfile(){this._router.navigate(this.pathToProfile)}navigateToSearch(){this._router.navigate(this.pathToSearch)}navigateToSettings(){this._router.navigate(this.pathToSettings)}navigateToAbout(){this._router.navigate(this.pathToAbout)}navigateToLegal(){this._router.navigate(this.pathToLegal)}navigateToLogin(){this.isNavigatingToLogin.set(!0),this._router.navigate(this.pathToLogin)}navigateIfAuthenticated(e,t){this._router.navigate(t?[e]:this.pathToLogin)}get pathToHome(){return["/home"]}get pathToProfile(){return["/profile"]}get pathToSearch(){return["/search"]}get pathToCollections(){return["/collections"]}get pathToSettings(){return["/settings"]}get pathToAbout(){return["/about"]}get pathToLegal(){return["/legal"]}get pathToLogin(){return["/login"]}static \u0275fac=function(t){return new(t||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};var E=(n=>(n.Media="media",n.Series="series",n.Season="season",n.Episode="episode",n.Custom="custom",n))(E||{});var R=class d{userService=u(w);collectionService=u(T);collectionItemService=u(A);notificationService=u(b);navigationService=u(C);currentCollection=p(null);currentCollectionItems=p(null);currentCollectionOwner=p(null);currentRatedItems=v(()=>this.currentCollectionItems()?.filter(e=>!e.toDo));currentToDoItems=v(()=>this.currentCollectionItems()?.filter(e=>e.toDo));isCollectionOwner=v(()=>this.currentCollection()?.userId===this.userService.selfUser()?.id);setCurrentCollectionData(e,t,i){this.currentCollection.set(e),this.currentCollectionItems.set(t),this.currentCollectionOwner.set(i)}resetState(){this.currentCollection.set(null),this.currentCollectionItems.set(null),this.currentCollectionOwner.set(null)}renameCollection(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionName(t.id,e,t.name).pipe(l(()=>{this.currentCollection.update(i=>i?a(r({},i),{name:e}):null)}),s(()=>(this.notificationService.showFailure(),c))).subscribe()}changeCollectionPublicStatus(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionPublicStatus(t.id,e).pipe(l(()=>{this.currentCollection.update(i=>i?a(r({},i),{isPublic:e}):null)}),s(()=>(this.notificationService.showFailure(),c))).subscribe()}deleteCollection(){let e=this.currentCollection();e&&this.collectionService.deleteCollection(e.id).pipe(l(()=>{this.resetState(),this.navigationService.navigateTo("/collections")}),s(()=>(this.notificationService.showFailure(),c))).subscribe()}addCustomItem(e){return this.addItem(e,t=>this.collectionItemService.addCustomItem(t))}addMediaItem(e){return this.addItem(e,t=>this.collectionItemService.addMediaItem(t))}toggleItemToDoStatus(e){let t=this.currentCollectionItems()?.findIndex(n=>n.id===e);if(t===void 0||t===-1)return;let i=!this.currentCollectionItems()?.at(t)?.toDo,o={id:e,toDo:i};this.collectionItemService.updateItemToDoStatus(o).pipe(l(()=>{this.currentCollectionItems.update(n=>{if(!n)return n;let m=[...n];return m[t]=a(r({},m[t]),{toDo:i}),this.notificationService.showSuccess("Status zmieniony pomy\u015Blnie"),m})}),s(()=>(this.notificationService.showFailure(),c))).subscribe()}deleteCollectionItem(e){this.collectionItemService.deleteItem(e).pipe(l(()=>{this.currentCollectionItems.update(t=>{if(!t)return t;let i=t.findIndex(n=>n.id===e);if(i===-1)return t;let o=[...t];return o.splice(i,1),this.notificationService.showSuccess(),o})}),s(()=>(this.notificationService.showFailure(),c))).subscribe()}updateItemRating(e){return this.collectionItemService.updateItemRating(e).pipe(l(()=>{this.currentCollectionItems.update(t=>t?t.map(i=>i.id===e.id?a(r({},i),{rating:e.rating}):i):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),h(!1))))}updateSeriesSubItemRating(e){if(!this.isValidModel(e))return this.notificationService.showFailure(),h(!1);let t=this.isEpisodeChange(e);return this.sendSubItemRatingUpdate(e,t).pipe(l(i=>{this.currentCollectionItems.update(o=>o?o.map(n=>this.updateSeriesItem(n,e,i,t)):null)}),I(()=>!0),s(()=>(this.notificationService.showFailure(),h(!1))))}updateCustomItemTitle(e,t){this.collectionItemService.updateCustomItemTitle(e,t).pipe(l(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?a(r({},o),{item:a(r({},o.item),{title:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),c))).subscribe()}updateCustomItemDescription(e,t){this.collectionItemService.updateCustomItemDescription(e,t).pipe(l(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?a(r({},o),{item:a(r({},o.item),{description:t})}):o):null)}),s(i=>(this.notificationService.showFailure(i.message),c))).subscribe()}addItem(e,t){return t(e).pipe(l(i=>{this.currentCollectionItems.update(o=>o?[...o,i]:[i])}),I(()=>!0),s(i=>{let o=i instanceof Error?i.message:typeof i=="string"?i:void 0;return this.notificationService.showFailure(o),h(!1)}))}isValidModel(e){return!!(e.seriesCollectionItemId&&(e.seasonApiId||e.seasonCollectionItemId))}isEpisodeChange(e){return!!(e.episodeCollectionItemId||e.episodeApiId)}updateSeriesItem(e,t,i,o){if(e.id!==t.seriesCollectionItemId)return e;let n=e,m=n.item.seasons.map(S=>this.updateSeason(S,t,i,o));return a(r({},n),{item:a(r({},n.item),{seasons:m})})}updateSeason(e,t,i,o){let n=!!t.seasonCollectionItemId&&t.seasonCollectionItemId===e.id,m=!t.seasonCollectionItemId&&e.item.apiId===t.seasonApiId;if(!n&&!m)return e;if(o){let S=e.item.episodes.map(D=>this.updateEpisode(D,t,i));return a(r({},e),{item:a(r({},e.item),{episodes:S})})}else return n?a(r({},e),{rating:t.value}):i?a(r({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}updateEpisode(e,t,i){return t.episodeCollectionItemId?t.episodeCollectionItemId!==e.id?e:a(r({},e),{rating:t.value}):e.item.apiId!==t.episodeApiId?e:i?a(r({},e),{id:i.id,rating:i.rating,toDo:i.toDo,addedAt:i.addedAt}):e}sendSubItemRatingUpdate(e,t){return t?e.episodeCollectionItemId?this.collectionItemService.updateItemRating({id:e.episodeCollectionItemId,rating:e.value}):this.collectionItemService.addEpisodeCollectionItem({collectionId:this.currentCollection().id,apiId:e.episodeApiId,rating:e.value,toDo:!1}):e.seasonCollectionItemId?this.collectionItemService.updateItemRating({id:e.seasonCollectionItemId,rating:e.value}):this.collectionItemService.addSeasonCollectionItem({collectionId:this.currentCollection().id,apiId:e.seasonApiId,rating:e.value,toDo:!1})}static \u0275fac=function(t){return new(t||d)};static \u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})};export{C as a,E as b,R as c};
