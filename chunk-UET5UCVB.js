import{a as I,b as y}from"./chunk-N7J3XVY2.js";import{a as A}from"./chunk-65KQNILW.js";import{a as E}from"./chunk-EQNPCEY6.js";import{l as g}from"./chunk-EP6N3N6R.js";import{a as w}from"./chunk-PCYLCH52.js";import{x as v}from"./chunk-WJTMIWFM.js";import{B as l,Eb as S,Z as a,ad as C,ba as b,ha as p,j as u,l as m,p as h}from"./chunk-S4ZUGAIY.js";import{a as r,b as s}from"./chunk-EQDQRRRY.js";var R=(n=>(n.Media="media",n.Series="series",n.Season="season",n.Episode="episode",n.Custom="custom",n))(R||{});var M=class f{userService=p(A);collectionService=p(E);collectionItemService=p(y);notificationService=p(g);navigationService=p(w);statusChangedSuccessMessage=v("notification.statusChangedSuccess");itemAlreadyInCollectionMessage=v("notification.itemAlreadyInCollection");currentCollection=S(null);currentCollectionItems=S(null);currentCollectionOwner=S(null);currentRatedItems=C(()=>this.currentCollectionItems()?.filter(e=>e.status===I.done)??[]);currentInProgressItems=C(()=>this.currentCollectionItems()?.filter(e=>e.status===I.inProgress)??[]);currentToDoItems=C(()=>this.currentCollectionItems()?.filter(e=>e.status===I.todo)??[]);isCollectionOwner=C(()=>this.currentCollection()?.userId===this.userService.selfUser()?.id);setCurrentCollectionData(e,t,i){this.currentCollection.set(e),this.currentCollectionItems.set(t),this.currentCollectionOwner.set(i)}resetState(){this.currentCollection.set(null),this.currentCollectionItems.set(null),this.currentCollectionOwner.set(null)}renameCollection(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionName(t.id,e,t.name).pipe(a(()=>{this.currentCollection.update(i=>i?s(r({},i),{name:e}):null)}),l(()=>(this.notificationService.showFailure(),u))).subscribe()}changeCollectionPublicStatus(e){let t=this.currentCollection();t&&this.collectionService.updateCollectionPublicStatus(t.id,e).pipe(a(()=>{this.currentCollection.update(i=>i?s(r({},i),{isPublic:e}):null)}),l(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollection(){let e=this.currentCollection();e&&this.collectionService.deleteCollection(e.id).pipe(a(()=>{this.resetState(),this.navigationService.navigateTo("/collections")}),l(()=>(this.notificationService.showFailure(),u))).subscribe()}addCustomItem(e){return this.addItem(e,t=>this.collectionItemService.addCustomItem(t))}addMediaItem(e){return this.addItem(e,t=>this.collectionItemService.addMediaItem(t))}updateItemStatus(e,t){let i=this.currentCollectionItems()?.findIndex(c=>c.id===e);if(i===void 0||i===-1)return;var o=this.currentCollectionItems()?.at(i)?.status;if(t===o)return;let n={id:e,status:t};this.collectionItemService.updateItemStatus(n).pipe(a(()=>{this.currentCollectionItems.update(c=>{if(!c)return c;let d=[...c];return d[i]=s(r({},d[i]),{status:t}),this.notificationService.showSuccess(this.statusChangedSuccessMessage()),d})}),l(()=>(this.notificationService.showFailure(),u))).subscribe()}deleteCollectionItem(e){this.collectionItemService.deleteItem(e).pipe(a(()=>{this.currentCollectionItems.update(t=>{if(!t)return t;let i=t.findIndex(n=>n.id===e);if(i===-1)return t;let o=[...t];return o.splice(i,1),this.notificationService.showSuccess(),o})}),l(()=>(this.notificationService.showFailure(),u))).subscribe()}updateItemRating(e){return this.collectionItemService.updateItemRating(e).pipe(a(()=>{this.currentCollectionItems.update(t=>t?t.map(i=>i.id===e.id?s(r({},i),{rating:e.rating}):i):null)}),h(()=>!0),l(()=>(this.notificationService.showFailure(),m(!1))))}updateSeriesSubItemRating(e){if(!this.isValidModel(e))return this.notificationService.showFailure(),m(!1);let t=this.isEpisodeChange(e);return this.sendSubItemRatingUpdate(e,t).pipe(a(i=>{this.currentCollectionItems.update(o=>o?o.map(n=>this.updateSeriesItem(n,e,i,t)):null)}),h(()=>!0),l(()=>(this.notificationService.showFailure(),m(!1))))}updateCustomItemTitle(e,t){this.collectionItemService.updateCustomItemTitle(e,t).pipe(a(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?s(r({},o),{item:s(r({},o.item),{title:t})}):o):null)}),l(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}updateCustomItemDescription(e,t){this.collectionItemService.updateCustomItemDescription(e,t).pipe(a(()=>{this.currentCollectionItems.update(i=>i?i.map(o=>o.id===e.id&&o.itemType=="custom"&&o.item?s(r({},o),{item:s(r({},o.item),{description:t})}):o):null)}),l(i=>(this.notificationService.showFailure(i.message),u))).subscribe()}addItem(e,t){return t(e).pipe(a(i=>{this.currentCollectionItems.update(o=>o?[...o,i]:[i])}),h(()=>({result:!0,alreadyExists:!1})),l(i=>{let o=i instanceof Error?i.message:typeof i=="string"?i:void 0;return o==="The item is already part of the selected collection."?(this.notificationService.showFailure(this.itemAlreadyInCollectionMessage()),m({result:!1,alreadyExists:!0})):(this.notificationService.showFailure(o),m({result:!1,alreadyExists:!1}))}))}isValidModel(e){return!!(e.seriesCollectionItemId&&(e.seasonApiId||e.seasonCollectionItemId))}isEpisodeChange(e){return!!(e.episodeCollectionItemId||e.episodeApiId)}updateSeriesItem(e,t,i,o){if(e.id!==t.seriesCollectionItemId)return e;let n=e,c=n.item.seasons.map(d=>this.updateSeason(d,t,i,o));return s(r({},n),{item:s(r({},n.item),{seasons:c})})}updateSeason(e,t,i,o){let n=!!t.seasonCollectionItemId&&t.seasonCollectionItemId===e.id,c=!t.seasonCollectionItemId&&e.item.apiId===t.seasonApiId;if(!n&&!c)return e;if(o){let d=e.item.episodes.map(x=>this.updateEpisode(x,t,i));return s(r({},e),{item:s(r({},e.item),{episodes:d})})}else return n?s(r({},e),{rating:t.value}):i?s(r({},e),{id:i.id,rating:i.rating,status:i.status,addedAt:i.addedAt}):e}updateEpisode(e,t,i){return t.episodeCollectionItemId?t.episodeCollectionItemId!==e.id?e:s(r({},e),{rating:t.value}):e.item.apiId!==t.episodeApiId?e:i?s(r({},e),{id:i.id,rating:i.rating,status:i.status,addedAt:i.addedAt}):e}sendSubItemRatingUpdate(e,t){return t?e.episodeCollectionItemId?this.collectionItemService.updateItemRating({id:e.episodeCollectionItemId,rating:e.value}):this.collectionItemService.addEpisodeCollectionItem({collectionId:this.currentCollection().id,apiId:e.episodeApiId,rating:e.value,status:I.done}):e.seasonCollectionItemId?this.collectionItemService.updateItemRating({id:e.seasonCollectionItemId,rating:e.value}):this.collectionItemService.addSeasonCollectionItem({collectionId:this.currentCollection().id,apiId:e.seasonApiId,rating:e.value,status:I.done})}static \u0275fac=function(t){return new(t||f)};static \u0275prov=b({token:f,factory:f.\u0275fac,providedIn:"root"})};export{R as a,M as b};
